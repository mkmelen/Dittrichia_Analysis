---
title: "Relative fitness in a field setting - Figure 4 (Evolution MS)"
output: html_notebook
date: December 2022
author: Miranda Melen
contributors: Laura Goetz, Matt Kustra, Julia Harenčár, and Nicky Lustenhouwer
---
#Background
At Blue Oak Ranch Reserve, we established a 10m x 26m fenced field site to test whether evolution over the course of invasion away from roads has resulted in enhanced performance in undisturbed vegetation relative to roadside populations. The experiment was replicated in a randomized block design (20 plots in total). Each plot was 1.5m2 with 16 D. graveolens growing in a 4 x 4 grid centered on the plot. There was 33cm between each plant and 25cm between the edge plants and the border of the plot.

The experiment included multiple treatments; however, only the two most relevant to the focus of this paper are included here. We tested whether plant genotypes collected from the two habitats (roadside and vegetated) responded differently to the disturbance of biomass removal. We tilled in December 2020 to completely remove below and aboveground biomass, and then weeded to remove aboveground biomass throughout the growing season. In contrast, we left the control plots untouched, allowing the previous year’s thatch to persist and background vegetation to grow throughout the experiment. 

In January 2021, we germinated seeds in Petri dishes at the UCSC Coastal Science Campus greenhouse incubation chambers before transplanting them into field-collected soil (collected in late December 2020 from Blue Oak Ranch Reserve). Seedlings grew in the greenhouse for about eight weeks until all plants had their first two true leaves emerge and lengthen. Ideally, we would have placed seeds directly into the field, but to maximize biosafety, we used seedling transplants that could be tracked with 100% certainty.

We measured the longest leaf for each plant and then transplanted them into the ground in late February 2021 at Blue Oak Ranch Reserve. During the first month of growth, we replaced any D. graveolens that died. We conducted weekly phenology surveys to assess D. graveolens plant health, and at the first sign of buds, we measured plant height and harvested the aboveground biomass by cutting at the root crown and drying in a 60ºC oven for 3 days before weighing.

#Data Analysis
Statistical analyses were performed in R version 4.2.1 (R Core Team 2022) using linear mixed-effects models with the lme4 (Bates et al. 2015), lmerTest (Kuznetsova et al. 2017), and DHARMa packages (Hartig 2022), generalized linear mixed models with the glmmTMB package (Brooks et al. 2017), and mixed effects cox models with the coxme (Therneau 2022a) and survival (Therneau 2022b) packages.

#Libraries
```{r}
#install.packages("coxme")
#install.packages("survival")
#install.packages("ggplot2")
#install.packages("ggfortify")
#install.packages("car")
#install.packages("multcomp")
#install.packages("lme4")
#install.packages("lmerTest")
#install.packages("DHARMa")
#install.packages("dplyr")
#install.packages("emmeans")
#install.packages('TMB', type = 'source')
#install.packages("glmmTMB")
#install.packages("MASS")
#install.packages("emmeans")
#install.packages("AICcmodavg")
library(coxme)
library(survival)
library(ggplot2)
library(ggfortify)
library(car)
library(multcomp)
library(lme4)
library(lmerTest)
library(DHARMa)
library(dplyr)
library(emmeans)
library(TMB)
library(glmmTMB)
library(MASS)
library(emmeans)
library(AICcmodavg)
library(tidyverse)
```

#Load Data
This dataframe has one row per plant (320 observations). Data are for survivorship curves (3 censor options), the number of days the plant stayed alive (NumDaysAlive) and aboveground biomass. Censors with a 1 denote reaching the event (CensorAll = died, CensorBiomass = survived to collect biomass, CensorReproduction = survived to reproduce) and a 0 denoting when a seed didn't germinate by the last census date (Census = 11/15/21). CensorReproduction will be most useful in understanding the amount of biomass produced by an individual when buds appear.
```{r}
mydata<-read.csv("/Users/Miranda/Documents/Education/UC Santa Cruz/Dittrichia/Dittrichia_Analysis/data/field_relative_fitness/MS_Evolution_Fig4_2021.csv",stringsAsFactors=T)
str(mydata) #Check that each column has the right class (factor, integer, numeric, etc.)
mydata$Site<-as.character(mydata$Site)
mydata$Treatment<-factor(mydata$Treatment,
                         levels=c("Grassland","Biomass Removal")) #Changing the contrast order so that everything is compared to Grassland (control)
```

#Early Growth
This code uses Growth data with Habitat (roadside and vegetated) and Treatment in a glmm model. Anova and Tukey tests are used on the successful Model4 with the creation of a box plot as a finished product.

Note: 10 blocks, 2 treatments, 16 populations (CHE-O), 8 sites (random: population pairs; CHE), 2 habitat (fixed effect: roadside and vegetated; R or O)

Also Note: Growth data is a measure of growth of longest leaf. Each plant was measured upon transplanting into the field in March and then again in May 2021. This plant has a juvenile stage of a basal rosette, and then it bolts and produced smaller cauline leaves. The goal was to capture early growth data for this plant before bolting occurs so that the measurements capture the basal rosette stage, however in some cases the plants bolted earlier than expected and the resulting measurement was smaller than previous. In these cases we determined that the data should be removed from the dataset as the negative number (or changing it to a zero) does not reflect the biological importance of the measurement.

Here we need to filter the data to remove Growth>0 and to convert plant measurement dates to date format
```{r}
growth_mydata<-mydata%>%filter(Growth>0) #Here I am only looking at the Growth data that is greater than 0 (see Also Note above)
growth_mydata$PlantDate<-as.Date(growth_mydata$PlantDate,"%m/%d/%y") 

growth_mydata$Num.Days.Growth<-as.Date("2021-05-22")-growth_mydata$PlantDate #number days
growth_mydata$Num.Days.Growth<-as.numeric(growth_mydata$Num.Days.Growth)
growth_mydata$Growth.Rate<-growth_mydata$Growth/growth_mydata$Num.Days.Growth #First calculate number of days of growth to get the Rate 
```

##Histograms
###Original data
When we plot the original data as a histogram, we find that it is skewed. We also use the Shapiro-Wilk normality test, but get a p-value = 1.402e-05.

In statistical hypothesis testing, a common significance level (alpha) is set at 0.05. If the p-value is less than alpha (p-value < alpha), it suggests strong evidence against the null hypothesis. In this case, the p-value is extremely small (less than 1.402e-05), indicating very strong evidence against the null hypothesis.

Therefore, based on the given output, it can be concluded that the dataset did not pass the Shapiro-Wilk normality test. The data is unlikely to follow a normal distribution. Let's consider log transforming the data.
```{r}
hist(growth_mydata$Growth.Rate,
     col='steelblue',
     main='Original') 
shapiro.test(growth_mydata$Growth.Rate)
```

###Log transform data
(https://www.statology.org/transform-data-in-r/)
When we log transform the data and plot using a histogram, the data does not look, but we need to still test for normalicy with a Shapiro-Wilk normality test. Here we find that the data are not normally distributed because the p-value = 7.398e-14.
```{r}
log_growth_mydata<-log10(growth_mydata$Growth.Rate)
hist(log_growth_mydata,
     col='steelblue',main='Log Transformed') #Log transformed data does not look good at all!
shapiro.test(log_growth_mydata) #Data does not improve with log transformation

qqnorm(log_growth_mydata) #qqplot
qqline(log_growth_mydata) #add the line 
```

###Square root transform data
This improved the distribution, but it failed the Shapiro-Wilk normality test (p-value = 0.001034). Let's try poisson.
```{r}
sqrt_growth_mydata<-sqrt(growth_mydata$Growth.Rate)
hist(sqrt_growth_mydata,
     col='steelblue',main='Square Root Transformed') #Square root transformed data looks better than the original distribution
shapiro.test(sqrt_growth_mydata)

qqnorm(sqrt_growth_mydata) #qqplot
qqline(sqrt_growth_mydata) #add the line 
```

###Poisson distribution
Poisson is actually not a good fit because the growth rate is not an integer (has decimals), which poisson is not equipt to deal with. Maybe I'll try gamma?
```{r}
library(MASS)
MASS::fitdistr((growth_mydata$Growth.Rate*1000),
               "Poisson")
qqPlot(growth_mydata$Growth.Rate,
       distribution="pois",
       lambda=1)
```

###Gamma distribution
Nope, not gamma
```{r}
gamma<-fitdistr(growth_mydata$Growth.Rate,
                "gamma")
qqp(growth_mydata$Growth.Rate,
    "gamma",
    shape=gamma$estimate[[1]],
    rate=gamma$estimate[[2]])
```

##Models
###Full Model 1 - glmm

```{r}
growth_fullmodel1<-glmmTMB(Growth.Rate~
                             Habitat*Treatment+
                             (1|Site)+
                             (1|Block),
                           family=Gamma(link="log"),
                           data=growth_mydata) 
summary(growth_fullmodel1)
qqnorm(resid(growth_fullmodel1)) #qqplot
qqline(resid(growth_fullmodel1)) #add the line
testDispersion(growth_fullmodel1) #red line should be in the middle of the distribution
myDHARMagraph_grow1<-simulateResiduals(growth_fullmodel1) #making a graph using DHARMa package, also testing for heteroscedasticity, https://cran.r-project.org/web/packages/DHARMa/vignettes/DHARMa.html#heteroscedasticity
plot(myDHARMagraph_grow1) #plotting graph. Looks good, but check the outliers to make sure they are real.
```

###Full Model 2 - lmer
```{r}
growth_fullmodel2<-lmer(sqrt(Growth.Rate)~
                          Habitat*Treatment+
                          (1|Site)+
                          (1|Block),
                        data=growth_mydata)
isSingular(growth_fullmodel2,
           tol=1e-4) #=False
summary(growth_fullmodel2)
anova(growth_fullmodel2)

qqnorm(resid(growth_fullmodel2)) #qqplot
qqline(resid(growth_fullmodel2)) #add the line
testDispersion(growth_fullmodel2) #red line should be in the middle of the distribution
myDHARMagraph_grow2<-simulateResiduals(growth_fullmodel2) #making a graph using DHARMa package, also testing for heteroscedasticity, https://cran.r-project.org/web/packages/DHARMa/vignettes/DHARMa.html#heteroscedasticity
plot(myDHARMagraph_grow2) #plotting graph. At this point, you don't want any text or lines to be red. The QQ plots are not looking good for this model. Let's try fitting to a negative binomial distribution.
```

###Other Model Attempts
####lmer with log data
Modeling Habitat and Treatment with Site and Block as random effects. For this  model, we use the log(Growth.Rate) data. The qqplot does not look good.
```{r eval=FALSE, include=FALSE}
growth_fullmodel2<-lmer(log(Growth.Rate)~
                          Habitat*Treatment+
                          (1|Site)+
                          (1|Block),
                        data=growth_mydata)
summary(growth_fullmodel2) #Site accounts for 1% of the variance
anova(growth_fullmodel2)

qqnorm(resid(growth_fullmodel2)) #qqplot
qqline(resid(growth_fullmodel2)) #add the line
testDispersion(growth_fullmodel2) #red line should be in the middle of the distribution
myDHARMagraph2<-simulateResiduals(growth_fullmodel2) #making a graph using DHARMa package, also testing for heteroscedasticity, https://cran.r-project.org/web/packages/DHARMa/vignettes/DHARMa.html#heteroscedasticity
plot(myDHARMagraph2) #plotting graph. At this point, you don't want any text or lines to be red. The QQ plots are not looking good for this model. Let's try fitting to a negative binomial distribution.
```

####glmer.nb: Negative Binomial
Here I tried fitting my data to a negative binomial distribution, but my data are non-integer, so this model won't work. Let's try building a model and fitting it to a Beta distribution which can deal with non-integers (between 0 and 1), first without a link function. Check it with DHARMa, and if it doesn't look good, then fit it to a Beta distribution with a logit link function.

fullmodel<-glmer.nb(Growth.Rate)~   #Response variable: growth rate
          Habitat*Treatment+        #Fixed effects and their interactions(*)
          (1|Site)+(1|Block),       #Random effect with random intercept only
          data=mydata)              #Dataframe

Generalized linear mixed-effects model (GLMM) with a negative binomial distribution is part of the lme4 package, which is commonly used for fitting various types of mixed-effects models.

The negative binomial distribution is often used to model count data that exhibit overdispersion, meaning the variance is greater than the mean. This distribution is useful when the assumption of a Poisson distribution (equal mean and variance) is violated.

The glmer.nb() function specifically fits a GLMM with a negative binomial distribution by taking into account both fixed effects (predictors) and random effects (grouping factors). It allows for the modeling of correlated data where observations within the same group may be more similar to each other than to observations from other groups.

```{r eval=FALSE, include=FALSE}
growth_fullmodel3<-glmer.nb(Growth.Rate~
                              Habitat*Treatment+
                              (1|Site)+
                              (1|Block),
                            data=growth_mydata) #this barfs because I have non-integers - whoops!
```

####glmm: Beta Distribution
Turns out this was also not helpful because beta distributions are for proportions, which this is not.But I'll keep this here for future reference.

fullmodel<-glmmTMB(Growth.Rate~    #Response variable: growth rate
          Habitat*Treatment+       #Fixed effects and their interactions (*)
          (1|Site)+(1|Block),      #Random effect with random intercept only
          family=beta_family(),    #Specify the family as beta_family (for beta regression)
          data=growth_mydata)      #Dataframe

Generalized linear mixed-effects models (GLMMs) using a template model builder (TMB) framework. GLMMs are a type of statistical model that extends generalized linear models (GLMs) to account for correlated or clustered data, hierarchical structures, and random effects. They are suitable for analyzing data with non-normal response variables or data that violate the assumptions of traditional linear models.

The glmmTMB() function allows you to specify a GLMM using a formula syntax similar to GLMs. It supports various families of distributions (e.g., Gaussian, binomial, Poisson) and link functions, allowing for the analysis of different types of response variables. Additionally, it allows for the inclusion of both fixed effects (predictors) and random effects (grouping factors) to capture the variability within and between groups.

The TMB framework implemented in glmmTMB utilizes efficient algorithms for model fitting and parameter estimation. It offers computational advantages, making it particularly useful for large datasets or models with complex structures. The package also provides functionality for handling zero-inflation, overdispersion, and handling non-Gaussian response distributions.

```{r eval=FALSE, include=FALSE}
#this model didn't pan out because although my data is non-normal and non-integer, beta distributions are for proportional data, which growth rate is not. Scrap this idea too.
growth_fullmodel4<-glmmTMB(Growth.Rate~
                             Habitat*Treatment+
                             (1|Site)+
                             (1|Block),
                           family=beta_family(),
                           data=growth_mydata) 
summary(growth_fullmodel4)
qqnorm(resid(growth_fullmodel4)) #qqplot
qqline(resid(growth_fullmodel4)) #add the line
testDispersion(growth_fullmodel4) #red line should be in the middle of the distribution
myDHARMagraph4<-simulateResiduals(growth_fullmodel4) #making a graph using DHARMa package, also testing for heteroscedasticity, https://cran.r-project.org/web/packages/DHARMa/vignettes/DHARMa.html#heteroscedasticity
plot(myDHARMagraph4) #plotting graph. Looks good, but check the outliers to make sure they are real.

growth_outlier_boxplot1<-ggplot(growth_mydata)+
  geom_boxplot(aes(x=Habitat,
                   y=Growth.Rate),
               size=0.5)+
  theme_classic()+
  ylim(0,1)+
  scale_fill_manual(values=c("forestgreen","gray85"))+
  labs(y="Early Growth Rate",
       fill="Habitat",
       x="Habitat")
growth_outlier_boxplot1

max(growth_mydata$Growth.Rate[growth_mydata$Habitat=="Vegetated"])
max(growth_mydata$Growth.Rate[growth_mydata$Habitat=="Roadside"]) #Yes, these outliers make sense, so I don't need to worry about the red stars in the DHARMa plot.

#Post-Hoc Test, but first remove non-significant interaction terms before running the Tukey.

#?emmeans,emmeans(model,pairwise~treatment)
growth_fullmodel4.1<-glmmTMB(Growth.Rate~
                               Treatment+
                               (1|Site)+
                               (1|Block),
                             family=beta_family(),
                             data=growth_mydata)
summary(growth_fullmodel4.1)
emmeans(growth_fullmodel4.1,
        pairwise~Treatment)
```

###Best Model
```{r}
growth_fullmodel2<-lmer(sqrt(Growth.Rate)~
                          Habitat*Treatment+
                          (1|Site)+
                          (1|Block),
                        data=growth_mydata)
summary(growth_fullmodel2)
```


#Survival Analysis
This code uses NumDaysAlive data with Habitat (roadside and vegetated) and Treatment in a Cox proportional hazards model to assess survival. Information here: https://cran.r-project.org/web/packages/coxme/vignettes/coxme.pdf. "Surv" creates a survival object to combine the days column (NumDaysAlive) and the reproductive censor column (ReproductionCensor) to be used as a response variable in a model formula. The model follows the same syntax as linear models (lm, lmer, etc). Fixed effects: "var1 * var2" will give you the interaction term and the individual variables: so "var1 + var2 + var1:var2". To add random effects, type "+ (1|random effect)". 

##Histograms
```{r}
#Number of Days Alive - All data
hist(mydata$NumDaysAlive,
     col='steelblue',
     main='Original') 

#Number of Days Alive - By Habitat
ggplot(mydata,
       aes(x=NumDaysAlive))+
  geom_histogram()+
  facet_wrap(vars(Habitat)) #Here we see that both Habitats have the same bi-modal distribution.

#Number of Days Alive - By Treatment
ggplot(mydata,
       aes(x=NumDaysAlive))+
  geom_histogram()+
  facet_wrap(vars(Treatment))
```

##Models
Cox proportional hazard models
Here we will use 'coxme' which allows you to conduct mixed effects Cox proportional hazards models. Information here: https://cran.r-project.org/web/packages/coxme/vignettes/coxme.pdf. We conducted a germination experiment using Dittrichia graveolens seeds on filter paper. "Surv" creates a survival object to combine the days column (NumDaysAlive) and the censor column (CensorReproduction) to be used as a response variable in a model formula. The model follows the same syntax as linear models (lm, lmer, etc). Fixed effects: "var1 * var2" will give you the interaction term and the individual variables: so "var1 + var2 + var1:var2". To add random effects, type "+ (1|random effect)".

Assumptions for cox models: https://www.theanalysisfactor.com/assumptions-cox-regression/

###Simple Model
Start by making a simple model with no random effects. This will be compared to the full model with random effects.
```{r}
cox_simplemodel1<-coxph(Surv(NumDaysAlive,
                             CensorReproduction)~ #Only those that survived to bud are included
                          Habitat*Treatment,
                        data=mydata)
summary(cox_simplemodel1)
print(cox_simplemodel1)
predict(cox_simplemodel1)
hist(predict(cox_simplemodel1))
```

###Full Model 1 - coxme
Now make a full model using random effects
```{r}
cox_fullmodel1<-coxme(Surv(NumDaysAlive,CensorReproduction)~
                        Habitat*Treatment+
                        (1|Site)+
                        (1|Block),
                      data=mydata)
summary(cox_fullmodel1)
print(cox_fullmodel1)
predict(cox_fullmodel1)
hist(predict(cox_fullmodel1))
```

Now we can compare the models to see which model is best, in this case it is fullmodel1.
```{r}
anova(cox_simplemodel1,cox_fullmodel1) 
#See example: https://www.rdocumentation.org/packages/coxme/versions/2.2-16/topics/coxme
AIC(cox_simplemodel1,cox_fullmodel1) #But comparing the AIC scores is easiest. Keep the lower AIC score because that is considered the better model. Here it is the fullmodel1.
```
###Full Model 2 - coxme
Now, let's make a model with no interaction term and then we'll compare that to the fullmodel1 which was deemed the best above.
```{r}
cox_fullmodel2<-coxme(Surv(NumDaysAlive,CensorReproduction)~
                        Habitat+
                        Treatment+
                        (1|Site)+
                        (1|Block),
                      data=mydata) 
summary(cox_fullmodel2)
```

Let's compare the the first two models to test for the significance of the term that is removed (using LR). Here we see that fullmodel2 has a lower AIC score so now it is the best model.
```{r}
anova(cox_fullmodel1,cox_fullmodel2) #Not significant
AIC(cox_fullmodel1,cox_fullmodel2) #The AIC scores are within 2 points of each other, so we can keep the simpler model, which is fullmodel2.
```

###Full Model 3 - coxme
So, now let's add in population nested under site as a random effect
```{r}
cox_fullmodel3<-coxme(Surv(NumDaysAlive,CensorReproduction)~
                        Habitat+
                        Treatment+
                        (1|Site/Population)+
                        (1|Block),
                      data=mydata) 
summary(cox_fullmodel3)
```

Now we can compare the models to see which model is best and we see that fullmodel3 has a lower AIC score.
```{r}
anova(cox_fullmodel2,cox_fullmodel3) #Significant
AIC(cox_fullmodel2,cox_fullmodel3) #Looks like fullmodel3 is the better model because of the lower AIC score
```

###Best Model
The effect of source habitat was also not significant for the proportion of survival to bud (Z = -0.09, P = 0.93, Figure 4B). Again, the treatment effect was significant but not the interaction between treatment and source habitat (Z = 6.56, P < 0.0001).
```{r}
cox_fullmodel3<-coxme(Surv(NumDaysAlive,CensorReproduction)~
                        Habitat+
                        Treatment+
                        (1|Site/Population)+
                        (1|Block),
                      data=mydata) 
summary(cox_fullmodel3)
```

####Risk Assessment
These values are found in the model summary, but if you want to pull them out, here is how you interpret them.
1 = no effect, <1 = decreased risk of death, >1 = increased risk of death.
```{r}
exp(coef(cox_fullmodel3)) #This should be interpreted that Biomass Removal is almost 9% more likely to survive to reproduction compared to Control.
exp(ranef(cox_fullmodel3)$Block)
exp(ranef(cox_fullmodel3)$Site) # Pretty even among all the sites
Anova(cox_fullmodel3)
```

For the next manuscript: Looks like roadside and vegetated populations are the same, so let's combine them together in a model (aka, removing the Habitat term)
```{r}
cox_fullmodel4<-coxme(Surv(NumDaysAlive,CensorReproduction)~
                        Treatment+
                        (1|Site/Population)+
                        (1|Block),
                      data=mydata) 
summary(cox_fullmodel4)
summary(cox_fullmodel3)
anova(cox_fullmodel3,cox_fullmodel4) #Significant
AIC(cox_fullmodel3,cox_fullmodel4) #Using the full dataset (not loaded here) it looks like fullmodel4 is the better model because the AIC score is within 2 points of each other, therefore the models are assessed the same and you should take the simpler model. But this is for another manuscript :-)
```

#Reproductive Biomass
This code uses Biomass data with Habitat (roadside and vegetated) and Treatment in a lmer model. ANOVA and Tukey are used on the successful Model 3 with the creation of a box plot as a finished product.

Note: 10 blocks, 5 treatments, 16 populations (CHE-O), 8 sites (random: population pairs; CHE), 2 habitat (fixed effect: roadside and vegetated; R or O)

Also Note: Biomass data is a measure of aboveground biomass of all individuals harvested from the site. In some cases this was before they budded, but we harvested the wilted plant in case that information was needed in the future. Here we only want to look at biomass (well, log(Biomass)) for reproductive individuals.

Here we need to subset the data to only look at Biomass when CensorReproduction = 1, so that all Biomass data is for reproductive individuals only.
```{r}
reproduction_mydata<-subset(mydata,CensorReproduction%in%c('1')) #Here I am only looking at the Biomass data where the CensorReproduction = 1
repro_mydata<-na.omit(reproduction_mydata)
```

##Histograms
###Original data
The original data is skewed and fails the Shapiro-Wilk normality test, so we should consider a log transformation.
```{r}
#All data
hist(repro_mydata$Biomass,col='steelblue',
     main='Original') #Original data is skewed, let's test for normality and consider log transforming the data
shapiro.test(repro_mydata$Biomass) #fails the Shapiro-Wilk normality test

#Biomass Removal data
biomass_hist<-repro_mydata %>%
  select(Biomass,Treatment) %>% 
  filter(Treatment =="Biomass Removal")
hist(biomass_hist$Biomass,breaks=20,col='steelblue',main='Original Biomass Removal')
```

###Log transform data 
(https://www.statology.org/transform-data-in-r/)
Log transformed data has a better distribution than the original data (although it still fails the Shapiro-Wilk normality test) so we will use the log transformed data with our models.

```{r}
log_reproduction_mydata<-log10(repro_mydata$Biomass)
hist(log_reproduction_mydata,col='steelblue',
     main='Log Transformed') #Log transformed data, this looks better than the original distribution
shapiro.test(log_reproduction_mydata) #but it fails this test

qqnorm(log_reproduction_mydata) #qqplot
qqline(log_reproduction_mydata) #add the line... kinda wobbly around the ends
```

###Square root transform data
Nope, not square root
```{r}
sqrt_biomass_mydata<-sqrt(repro_mydata$Biomass)
hist(sqrt_biomass_mydata,
     col='steelblue',main='Square Root Transformed') #nope, this does not look better
shapiro.test(sqrt_biomass_mydata)

qqnorm(sqrt_biomass_mydata) #qqplot
qqline(sqrt_biomass_mydata) #add the line 
```

###Poisson distribution
Poisson is actually not a good fit because the growth rate is not an integer (has decimals), which poisson cannot deal with. Maybe I'll try gamma?
```{r}
library(MASS)
MASS::fitdistr((repro_mydata$Biomass*1000),
               "Poisson")
qqPlot(repro_mydata$Biomass,
       distribution="pois",
       lambda=1)
```

###Gamma distribution
Maybe?
```{r}
gamma<-fitdistr(repro_mydata$Biomass,
                "gamma")
qqp(repro_mydata$Biomass,
    "gamma",
    shape=gamma$estimate[[1]],
    rate=gamma$estimate[[2]])
```

##Models
Julia recommends the log and gamma... then use DHARMa to test the dispersion of each models

###Full Model 1 - lmer: Modeling Habitat and Treatment with Site and Block as random effects
Site as a random effect does not explain any of the variance in the model, therefore let's try Site as a fixed effect to demonstrate that it doesn't add to the model.
```{r}
fullmodel1<-lmer(log(Biomass)~
                   Habitat*Treatment+
                   #(1|Site)+ we dropped site because it was a singular fit because it is described by habitat
                   (1|Block),
                 data=repro_mydata)
isSingular(fullmodel1,tol=1e-4) #false without site
summary(fullmodel1) #but this runs fine
anova(fullmodel1)
predict(fullmodel1)
hist(predict(fullmodel1,type="response"))

qqnorm(resid(fullmodel1)) #qqplot
qqline(resid(fullmodel1)) #add the line
testDispersion(fullmodel1) #red line should be in the middle of the distribution
myDHARMagraph1<-simulateResiduals(fullmodel1) #making a graph using DHARMa package, also testing for heteroscedasticity, https://cran.r-project.org/web/packages/DHARMa/vignettes/DHARMa.html#heteroscedasticity
plot(myDHARMagraph1) #plotting graph. At this point, you don't want any text or lines to be red.
```

###Full Model 2 - glmm
```{r}
fullmodel2<-glmmTMB(Biomass~
                             Habitat*Treatment+
                             (1|Site)+
                             (1|Block),
                           family=Gamma(link="log"),
                           data=repro_mydata) 
summary(fullmodel2)
qqnorm(resid(fullmodel2)) #qqplot
qqline(resid(fullmodel2)) #add the line
testDispersion(fullmodel2) #red line should be in the middle of the distribution
myDHARMagraph2<-simulateResiduals(fullmodel2) #making a graph using DHARMa package, also testing for heteroscedasticity, https://cran.r-project.org/web/packages/DHARMa/vignettes/DHARMa.html#heteroscedasticity
plot(myDHARMagraph2) #plotting graph. Looks good, but check the outliers to make sure they are real.
```
###Best Model
```{r}
fullmodel1<-lmer(log(Biomass)~
                   Habitat*Treatment+
                   #(1|Site)+ we dropped site because it was a singular fit because it is described by habitat
                   (1|Block),
                 data=repro_mydata)
fullmodel1
```


#ggplot - interaction plots
Treatment (Biomass Removal and Grassland) on the x-axis, using Roadside and Vegetated data

##Growth Rate x Treatment: Growth
```{r}
pd<-position_dodge(0)

growth_mydata2<-growth_mydata%>% 
  replace_na(list(Growth.Rate=0))%>%
  filter(CensorReproduction==1)%>%
  #filter(Treatment=="Biomass Removal"|Treatment=="Grassland")%>%
  group_by(Treatment,Habitat)%>%
  summarise(Mean=mean(Growth.Rate),
            SD=sd(Growth.Rate),
            N=length(Growth.Rate))%>%
  mutate(SE=SD/sqrt(N))

field_int_rate_grow_gg<-ggplot(growth_mydata2,
                        aes(x=factor(Treatment,levels=c("Biomass Removal","Grassland")),
                            y=Mean,
                            shape=Habitat,
                            group=Habitat,
                            color=Habitat))+
  coord_cartesian(ylim = c(0,0.5))+
  xlab("")+
  theme_bw(base_size=16)+
  theme(panel.border=element_blank(),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        axis.line=element_line(colour="black"),
        axis.title.y=ggtext::element_markdown(),
        legend.position = c(0.8, 0.8))+
 # ggtitle("Growth of Dittrichia graveolens that budded")+
  ylab("*Dittrichia graveolens* \n (Change in Leaf Length/Days)")+
  geom_line(size=0.8,
            position=pd)+
  geom_point(size=4,
             position=pd)+
  scale_shape_manual(values=c(16,2))+
  scale_color_manual(values=c("gray85","forestgreen"))+
  geom_errorbar(width=0.15,
                position=pd,
                aes(ymin=(Mean-SE),
                    ymax=(Mean+SE)))+
  labs(y="Change in Leaf Length/Day",
       color="Source Habitat",
       shape="Source Habitat")
field_int_rate_grow_gg

#ggsave(plot=field_int_rate_grow_gg,file="/Users/Miranda/Documents/Education/UC Santa Cruz/Dittrichia/Dittrichia_Analysis/figures/field_int_rate_grow_gg.png",width=25,height=15,units="cm",dpi=800)
```

##Survival to bud X Treatment
```{r}
pd<-position_dodge(0)

surv_mydata1<-mydata%>%
  #filter(Treatment=="Biomass Removal"|Treatment=="Grassland")%>%
  group_by(Treatment,Habitat)%>%
  summarise(Mean=mean(PropBudSite),
            SD=sd(PropBudSite),
            N=length(PropBudSite))%>%
  mutate(SE=SD/sqrt(N))

field_int_surv_all_gg<-ggplot(data=surv_mydata1,
                        aes(x=factor(Treatment,levels=c("Biomass Removal","Grassland")),
                            y=Mean,
                            shape=Habitat,
                            group=Habitat,
                            color=Habitat))+
  ylab("Proportion Survival to Bud")+
  coord_cartesian(ylim=c(0,1))+
  xlab("")+
  theme_classic(base_size=16)+
  theme(panel.border=element_blank(),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        axis.line=element_line(colour="black"),
        legend.position = c(0.8, 0.8))+
  scale_y_continuous(name="Proportion Survival to Bud",
                     limits=c(0,1),
                     breaks=c(0.0,0.2,0.4,0.6,0.8,1.0))+
  geom_line(size=0.8,
            position=pd)+
  geom_point(size=4,
             position=pd)+
  scale_shape_manual(values=c(16,2))+
  scale_color_manual(values=c("gray85","forestgreen"))+
  geom_errorbar(width=0.15,
                position=pd,
                aes(ymin=(Mean-SE),
                    ymax=(Mean+SE)))+
  labs(y="Proportion Survival to Bud",
       fill="Source Habitat",
       color="Source Habitat",
       shape="Source Habitat")
field_int_surv_all_gg

#ggsave(plot=field_int_surv_all_gg,file="/Users/Miranda/Documents/Education/UC Santa Cruz/Dittrichia/Dittrichia_Analysis/figures/field_int_surv_all_gg.png",width=25,height=15,units="cm",dpi=800)
```

##Biomass x Treatment: Growth
```{r}
pd<-position_dodge(0)

growth_mydata1<-growth_mydata%>% 
  replace_na(list(Biomass=0))%>%
  filter(CensorReproduction==1)%>%
#  filter(Treatment=="Biomass Removal"|Treatment=="Grassland")%>%
  group_by(Treatment,Habitat)%>%
  summarise(Mean=mean(Biomass),
            SD=sd(Biomass),
            N=length(Biomass))%>%
  mutate(SE=SD/sqrt(N))

field_int_bio_grow_gg<-ggplot(growth_mydata1,
                        aes(x=factor(Treatment,levels=c("Biomass Removal","Grassland")),
                            y=Mean,
                            shape=Habitat,
                            group=Habitat,
                            color=Habitat))+
  ylab("Biomass (g)")+
  coord_cartesian(ylim = c(0,10))+
  xlab("")+
  #ggtitle("Biomass of Dittrichia graveolens that budded")+
  theme_bw(base_size=16)+
  theme(panel.border=element_blank(),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        axis.line=element_line(colour="black"),
        axis.title.y=ggtext::element_markdown(),
        legend.position = c(0.8, 0.8))+
  geom_line(size=0.8,
            position=pd)+
  geom_point(size=4,
             position=pd)+
  scale_shape_manual(values=c(16,2))+
  scale_color_manual(values=c("gray85","forestgreen"))+
  geom_errorbar(width=0.15,
                position=pd,
                aes(ymin=(Mean-SE),
                    ymax=(Mean+SE)))+
  labs(y="*D. graveolens* Biomass (g)",
       color="Source Habitat",
       shape="Source Habitat")
field_int_bio_grow_gg

#ggsave(plot=field_int_bio_grow_gg,file="/Users/Miranda/Documents/Education/UC Santa Cruz/Dittrichia/Dittrichia_Analysis/figures/field_int_bio_grow_gg.png",width=25,height=15,units="cm",dpi=800)
```

##Figure 4 panel (3 plots)
```{r}
library(patchwork)

multi_panel_gg<-(field_int_rate_grow_gg+theme(legend.position = c(0.8,0.9)))/
  (field_int_surv_all_gg+theme(legend.position="none"))/
  (field_int_bio_grow_gg+theme(legend.position="none"))+
  plot_annotation(tag_levels=c("A"),
                  tag_suffix=")  ")&
  theme(text=element_text(size=8))
multi_panel_gg

ggsave(plot=multi_panel_gg,file="/Users/Miranda/Documents/Education/UC Santa Cruz/Dittrichia/Dittrichia_Analysis/figures/multi_panel_gg.png",width=8.5,height=17,units="cm",dpi=800)
```

##Figure 5?
```{r}
#Here's the best model
cox_fullmodel3<-coxme(Surv(NumDaysAlive,CensorReproduction)~
                        Habitat+
                        Treatment+
                        (1|Site/Population)+
                        (1|Block),
                      data=mydata) 

#Now let's try making survival curves to plot
cox_model_graph3<-survfit(Surv(NumDaysAlive,CensorReproduction)~
                            Habitat+
                            Treatment,
                          data=mydata)

surv_habitat_plot1<-autoplot(cox_model_graph3)+
  labs(x="Survival (Days)",
       y="Probability")+
  theme(plot.title=element_text(hjust=0.5),
        axis.title.x=element_text(face="bold",
                                  color="Black",
                                  size=12),
        axis.title.y=element_text(face="bold",
                                  color="Black",
                                  size=12))
surv_habitat_plot1
ggsave(plot=surv_habitat_plot1,file="/Users/Miranda/Documents/Education/UC Santa Cruz/Dittrichia/Dittrichia_Analysis/figures/surv_habitat_plot1.png",width=16,height=8,units="cm",dpi=800)

cox_model_graph4<-survfit(Surv(NumDaysAlive,CensorReproduction)~
                            Treatment+
                            Habitat,
                          data=mydata)

surv_habitat_plot2<-autoplot(cox_model_graph4)+
  labs(x="Survival (Days)",
       y="Probability")+
  theme(plot.title=element_text(hjust=0.5),
        axis.title.x=element_text(face="bold",
                                  color="Black",
                                  size=12),
        axis.title.y=element_text(face="bold",
                                  color="Black",
                                  size=12))
surv_habitat_plot2
ggsave(plot=surv_habitat_plot2,file="/Users/Miranda/Documents/Education/UC Santa Cruz/Dittrichia/Dittrichia_Analysis/figures/surv_habitat_plot2.png",width=16,height=8,units="cm",dpi=800)

```

New plot idea
http://sthda.com/english/wiki/survminer-r-package-survival-data-analysis-and-visualization#change-legend-title-labels-and-position

https://www.rdocumentation.org/packages/survminer/versions/0.4.9#computing-and-passin-p-values
```{r}
library("survminer")
library("survival")

cox_model_graph4<-survfit(Surv(NumDaysAlive,CensorReproduction)~
                            Habitat+
                            Treatment,
                          data=mydata)

surv_habitat_plot3 <- ggsurvplot(cox_model_graph4,
                               data = mydata,
                               xlab = "Survival (Days)",
                               ylab = "Probability",
                               surv.scale = "percent",
                               ggtheme = theme_bw() + theme(legend.position = "right"),
                               palette = c("gray30", "gray85", "forestgreen", "green3"),
                               #palette = c("yellowgreen", "forestgreen", "limegreen", "springgreen1"),
                               #palette = c("green3", "chartreuse3", "limegreen", "forestgreen"),
                               legend = c(0.21, 0.22),
                               legend.title = "Source Habitat",
                               #legend.labs = c("Roadside/Grassland",
                               #                "Roadside/Biomass Removal",
                               #                "Vegetated/Grassland",
                               #                "Vegetated/Biomass Removal"),
                               conf.int = TRUE,                 # Add confidence intervals
                               conf.int.style = "ribbon",       # Display confidence intervals as ribbons
                               risk.table = FALSE,
                               risk.table.y.text.col = FALSE,
                               pval = FALSE,
                               pval.coord = c(0.25, 0.9)
)
surv_habitat_plot3



#Trying this:
cox_model_graph4 <- survfit(Surv(NumDaysAlive, CensorReproduction) ~ Habitat + Treatment, data = mydata)

# Create a new variable for the combination of Habitat and Treatment
mydata$Strata <- paste(mydata$Habitat, mydata$Treatment, sep = "/")

# Modify the line types in the survfit object
strata_levels <- unique(mydata$Strata)
line_types <- c("solid", "dashed", "solid", "dashed")

cox_model_graph4$strata <- factor(mydata$Strata, levels = strata_levels)
cox_model_graph4$linetype <- line_types[match(cox_model_graph4$strata, strata_levels)]

surv_habitat_plot3 <- ggsurvplot(cox_model_graph4,
                                 data = mydata,
                                 xlab = "Survival (Days)",
                                 ylab = "Probability",
                                 surv.scale = "percent",
                                 ggtheme = theme_bw() + theme(legend.position = "right"),
                                 palette = c("gray30", "gray85", "forestgreen", "springgreen1"),
                                 legend = c(0.21, 0.22),
                                 legend.title = "Source Habitat",
                                 legend.labs = c("Roadside/Grassland",
                                                 "Roadside/Biomass Removal",
                                                 "Vegetated/Grassland",
                                                 "Vegetated/Biomass Removal"),
                                 conf.int = TRUE,                 # Add confidence intervals
                                 conf.int.style = "ribbon",       # Display confidence intervals as ribbons
                                 risk.table = FALSE,
                                 risk.table.y.text.col = FALSE,
                                 pval = FALSE,
                                 pval.coord = c(0.25, 0.9)
)

surv_habitat_plot3



#ggsave doesn't work with this type of plot
#ggsave(plot=surv_habitat_plot3,file="/Users/Miranda/Documents/Education/UC Santa Cruz/Dittrichia/Dittrichia_Analysis/figures/surv_habitat_plot3.png",width=25,height=15,units="cm",dpi=800)
```